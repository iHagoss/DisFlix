name: DisFlix MVP Build - Incremental with Auto-Save

on:
  workflow_dispatch:
    inputs:
      skip_to_checkpoint:
        description: 'Skip to checkpoint (0-13, or "none" to start fresh)'
        required: false
        default: 'none'
  push:
    branches:
      - test
      - main

jobs:
  checkpoint-0-setup:
    name: "Checkpoint 0: Initial Setup"
    runs-on: ubuntu-latest
    outputs:
      should_continue: ${{ steps.check.outputs.continue }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Check if we should skip this checkpoint
        id: check
        run: |
          if [[ "${{ github.event.inputs.skip_to_checkpoint }}" != "none" ]] && [[ "${{ github.event.inputs.skip_to_checkpoint }}" -gt 0 ]]; then
            echo "Skipping checkpoint 0"
            echo "continue=false" >> $GITHUB_OUTPUT
          else
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Clean workspace
        if: steps.check.outputs.continue == 'true'
        run: |
          git clean -fdx app/build/ || true
          git clean -fdx app/.gradle/ || true

      - name: Create checkpoint marker
        if: steps.check.outputs.continue == 'true'
        run: |
          echo "Checkpoint 0 completed at $(date)" > .checkpoint-0-complete
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .checkpoint-0-complete
          git commit -m "CHECKPOINT 0: Initial setup complete" || true

      - name: Push checkpoint
        if: steps.check.outputs.continue == 'true'
        run: |
          git push origin HEAD || echo "Nothing to push"

  checkpoint-1-add-submodules:
    name: "Checkpoint 1: Add Critical Submodules"
    runs-on: ubuntu-latest
    needs: checkpoint-0-setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Check if already done
        id: check_done
        run: |
          if [ -f ".checkpoint-1-complete" ] && [[ "${{ github.event.inputs.skip_to_checkpoint }}" == "none" ]]; then
            echo "Checkpoint 1 already complete, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Add stremio-core-kotlin submodule
        if: steps.check_done.outputs.skip == 'false'
        run: |
          if [ ! -d "stremio-core-kotlin/.git" ]; then
            git submodule add https://github.com/Stremio/stremio-core-kotlin.git || true
            git submodule update --init --recursive stremio-core-kotlin
          fi

      - name: Commit stremio-core-kotlin
        if: steps.check_done.outputs.skip == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .gitmodules stremio-core-kotlin || true
          git commit -m "CHECKPOINT 1a: Added stremio-core-kotlin submodule" || true
          git push origin HEAD || true

      - name: Add stremio-core-web submodule
        if: steps.check_done.outputs.skip == 'false'
        run: |
          if [ ! -d "stremio-core-web/.git" ]; then
            git submodule add https://github.com/Stremio/stremio-core-web.git || true
            git submodule update --init --recursive stremio-core-web
          fi

      - name: Commit stremio-core-web
        if: steps.check_done.outputs.skip == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .gitmodules stremio-core-web || true
          git commit -m "CHECKPOINT 1b: Added stremio-core-web submodule" || true
          git push origin HEAD || true

      - name: Add vlc-android submodule
        if: steps.check_done.outputs.skip == 'false'
        run: |
          if [ ! -d "vlc-android/.git" ]; then
            git submodule add https://github.com/Stremio/vlc-android.git || true
            git submodule update --init --recursive vlc-android
          fi

      - name: Commit vlc-android
        if: steps.check_done.outputs.skip == 'false'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .gitmodules vlc-android || true
          git commit -m "CHECKPOINT 1c: Added vlc-android submodule" || true
          git push origin HEAD || true

      - name: Create checkpoint marker
        if: steps.check_done.outputs.skip == 'false'
        run: |
          echo "Checkpoint 1 completed at $(date)" > .checkpoint-1-complete
          git add .checkpoint-1-complete
          git commit -m "CHECKPOINT 1d: All critical submodules added" || true
          git push origin HEAD || true

      - name: Upload submodules state
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint-1-submodules-state
          path: |
            .gitmodules
            .checkpoint-1-complete

  checkpoint-2-rust-toolchains:
    name: "Checkpoint 2: Install Rust Android Toolchains"
    runs-on: ubuntu-latest
    needs: checkpoint-1-add-submodules
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Verify targets
        run: |
          rustup target list | grep android | tee rust-targets.log

      - name: Create checkpoint marker
        run: |
          echo "Rust Android toolchains installed at $(date)" > .rust-android-targets-installed
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .rust-android-targets-installed rust-targets.log || true
          git commit -m "CHECKPOINT 2: Rust Android toolchains installed" || true
          git push origin HEAD || true

      - name: Cache Rust toolchains
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.rustup/
          key: ${{ runner.os }}-rust-android-${{ hashFiles('**/Cargo.lock') }}

  checkpoint-3-configure-ndk:
    name: "Checkpoint 3: Configure Android NDK"
    runs-on: ubuntu-latest
    needs: checkpoint-2-rust-toolchains
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Create Rust cargo config
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-linux-android]
          ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android30-clang"

          [target.armv7-linux-androideabi]
          ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi30-clang"

          [target.i686-linux-android]
          ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android30-clang"

          [target.x86_64-linux-android]
          ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android30-clang"
          EOF

      - name: Commit cargo config
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .cargo/config.toml
          git commit -m "CHECKPOINT 3: Configured Rust for Android NDK" || true
          git push origin HEAD || true

  checkpoint-4-node-dependencies:
    name: "Checkpoint 4: Install Node Dependencies"
    runs-on: ubuntu-latest
    needs: checkpoint-3-configure-ndk
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install stremio-core-web dependencies
        run: |
          cd stremio-core-web
          npm install
          cd ..

      - name: Save stremio-core-web checkpoint
        run: |
          echo "stremio-core-web dependencies installed at $(date)" > .stremio-core-web-deps-installed
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .stremio-core-web-deps-installed
          git commit -m "CHECKPOINT 4a: stremio-core-web dependencies installed" || true
          git push origin HEAD || true

      - name: Install stremio-web dependencies
        run: |
          cd stremio-web
          npm install
          cd ..

      - name: Save stremio-web checkpoint
        run: |
          echo "stremio-web dependencies installed at $(date)" > .stremio-web-deps-installed
          git add .stremio-web-deps-installed
          git commit -m "CHECKPOINT 4b: stremio-web dependencies installed" || true
          git push origin HEAD || true

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            stremio-core-web/node_modules
            stremio-web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

  checkpoint-5-build-core-rust:
    name: "Checkpoint 5: Build stremio-core for Android"
    runs-on: ubuntu-latest
    needs: checkpoint-4-node-dependencies
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Restore Rust cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            stremio-core/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('stremio-core/**/Cargo.lock') }}

      - name: Build for ARM64
        run: |
          cd stremio-core
          cargo build --target aarch64-linux-android --release 2>&1 | tee ../build-aarch64.log
          cd ..

      - name: Commit ARM64 build log
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add build-aarch64.log
          git commit -m "CHECKPOINT 5a: Built stremio-core for aarch64" || true
          git push origin HEAD || true

      - name: Build for ARMv7
        run: |
          cd stremio-core
          cargo build --target armv7-linux-androideabi --release 2>&1 | tee ../build-armv7.log
          cd ..

      - name: Commit ARMv7 build log
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add build-armv7.log
          git commit -m "CHECKPOINT 5b: Built stremio-core for armv7" || true
          git push origin HEAD || true

      - name: Create completion marker
        run: |
          echo "stremio-core Android builds completed at $(date)" > .stremio-core-built
          git add .stremio-core-built
          git commit -m "CHECKPOINT 5c: All stremio-core Android builds completed" || true
          git push origin HEAD || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-core-libs
          path: |
            stremio-core/target/aarch64-linux-android/release/*.so
            stremio-core/target/armv7-linux-androideabi/release/*.so
            build-*.log

  checkpoint-6-build-kotlin-jni:
    name: "Checkpoint 6: Build stremio-core-kotlin JNI"
    runs-on: ubuntu-latest
    needs: checkpoint-5-build-core-rust
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download stremio-core artifacts
        uses: actions/download-artifact@v4
        with:
          name: stremio-core-libs

      - name: Build stremio-core-kotlin
        run: |
          cd stremio-core-kotlin
          chmod +x gradlew
          ./gradlew assembleRelease --stacktrace 2>&1 | tee ../build-kotlin.log
          cd ..

      - name: Check build success
        id: check_build
        run: |
          if [ -f "stremio-core-kotlin/build/outputs/aar/stremio-core-kotlin-release.aar" ]; then
            echo "Build successful"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy AAR to app/libs
        if: steps.check_build.outputs.success == 'true'
        run: |
          mkdir -p app/libs
          cp stremio-core-kotlin/build/outputs/aar/stremio-core-kotlin-release.aar app/libs/

      - name: Commit build results
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app/libs/*.aar build-kotlin.log || true
          if [ "${{ steps.check_build.outputs.success }}" == "true" ]; then
            git commit -m "CHECKPOINT 6: Built stremio-core-kotlin JNI bindings ✅" || true
          else
            git commit -m "CHECKPOINT 6: stremio-core-kotlin build FAILED ❌" || true
          fi
          git push origin HEAD || true

      - name: Upload JNI AAR
        if: steps.check_build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stremio-core-kotlin-aar
          path: app/libs/stremio-core-kotlin-release.aar

  checkpoint-7-build-wasm:
    name: "Checkpoint 7: Build stremio-core-web WASM"
    runs-on: ubuntu-latest
    needs: checkpoint-4-node-dependencies
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: stremio-core-web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('stremio-core-web/package-lock.json') }}

      - name: Install dependencies
        run: |
          cd stremio-core-web
          npm install

      - name: Build WASM
        run: |
          cd stremio-core-web
          npm run build 2>&1 | tee ../build-wasm.log
          cd ..

      - name: Check build success
        id: check_wasm
        run: |
          if [ -f "stremio-core-web/build/stremio-core-web.wasm" ] || [ -f "stremio-core-web/dist/stremio-core-web.wasm" ]; then
            echo "WASM build successful"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "WASM build failed"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy WASM to assets
        if: steps.check_wasm.outputs.success == 'true'
        run: |
          mkdir -p app/src/main/assets/web
          
          if [ -f "stremio-core-web/build/stremio-core-web.wasm" ]; then
            cp stremio-core-web/build/stremio-core-web.* app/src/main/assets/web/
          elif [ -f "stremio-core-web/dist/stremio-core-web.wasm" ]; then
            cp stremio-core-web/dist/stremio-core-web.* app/src/main/assets/web/
          fi

      - name: Commit WASM files
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app/src/main/assets/web/stremio-core-web.* build-wasm.log || true
          if [ "${{ steps.check_wasm.outputs.success }}" == "true" ]; then
            git commit -m "CHECKPOINT 7: Built stremio-core-web WASM ✅" || true
          else
            git commit -m "CHECKPOINT 7: WASM build FAILED ❌" || true
          fi
          git push origin HEAD || true

      - name: Upload WASM artifacts
        if: steps.check_wasm.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stremio-core-wasm
          path: app/src/main/assets/web/stremio-core-web.*

  checkpoint-8-build-web-ui:
    name: "Checkpoint 8: Build stremio-web UI"
    runs-on: ubuntu-latest
    needs: checkpoint-7-build-wasm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: stremio-web/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('stremio-web/package-lock.json') }}

      - name: Install dependencies
        run: |
          cd stremio-web
          npm install

      - name: Build Web UI
        run: |
          cd stremio-web
          npm run build 2>&1 | tee ../build-web.log
          cd ..

      - name: Check build success
        id: check_web
        run: |
          if [ -d "stremio-web/build" ] || [ -d "stremio-web/dist" ]; then
            echo "Web build successful"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "Web build failed"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy web assets
        if: steps.check_web.outputs.success == 'true'
        run: |
          mkdir -p app/src/main/assets/web
          
          if [ -d "stremio-web/build" ]; then
            cp -r stremio-web/build/* app/src/main/assets/web/
          elif [ -d "stremio-web/dist" ]; then
            cp -r stremio-web/dist/* app/src/main/assets/web/
          fi

      - name: Commit web assets
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app/src/main/assets/web/ build-web.log || true
          if [ "${{ steps.check_web.outputs.success }}" == "true" ]; then
            git commit -m "CHECKPOINT 8: Built stremio-web UI bundle ✅" || true
          else
            git commit -m "CHECKPOINT 8: Web build FAILED ❌" || true
          fi
          git push origin HEAD || true

      - name: Upload web UI artifacts
        if: steps.check_web.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stremio-web-bundle
          path: app/src/main/assets/web/

  checkpoint-9-vlc-setup:
    name: "Checkpoint 9: VLC Setup (Use SDK)"
    runs-on: ubuntu-latest
    needs: checkpoint-1-add-submodules
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Use existing VLC SDK
        run: |
          echo "Using vlc-android-sdk that's already in repo"
          ls -la vlc-android-sdk/ || echo "VLC SDK not found"

      - name: Create VLC ready marker
        run: |
          echo "VLC SDK ready at $(date)" > .vlc-ready
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .vlc-ready || true
          git commit -m "CHECKPOINT 9: VLC SDK ready" || true
          git push origin HEAD || true

  checkpoint-10-configure-gradle:
    name: "Checkpoint 10: Configure Build Files"
    runs-on: ubuntu-latest
    needs: [checkpoint-6-build-kotlin-jni, checkpoint-8-build-web-ui, checkpoint-9-vlc-setup]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create optimized build.gradle
        run: |
          mkdir -p app
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
              id 'kotlin-android'
          }

          android {
              namespace 'com.stremio.app'
              compileSdk 34

              defaultConfig {
                  applicationId "com.stremio.app"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0-mvp"
                  
                  ndk {
                      abiFilters 'arm64-v8a', 'armeabi-v7a'
                  }
              }

              buildTypes {
                  debug {
                      minifyEnabled false
                      debuggable true
                  }
                  release {
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = '17'
              }
              
              packagingOptions {
                  jniLibs {
                      useLegacyPackaging = true
                  }
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.webkit:webkit:1.9.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              
              // Local libraries
              implementation fileTree(dir: 'libs', include: ['*.aar', '*.jar'])
              
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

      - name: Commit build configuration
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app/build.gradle
          git commit -m "CHECKPOINT 10: Configured build.gradle ✅" || true
          git push origin HEAD || true

  checkpoint-11-verify-assets:
    name: "Checkpoint 11: Verify All Assets"
    runs-on: ubuntu-latest
    needs: checkpoint-10-configure-gradle
    steps:
      - name: Checkout code with all changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Verify assets
        run: |
          echo "Checking required files..."
          
          MISSING=0
          
          # Check WASM
          if [ -f "app/src/main/assets/web/stremio-core-web.wasm" ]; then
            echo "✅ stremio-core-web.wasm"
          else
            echo "❌ Missing: stremio-core-web.wasm"
            MISSING=1
          fi
          
          # Check web UI
          if [ -f "app/src/main/assets/web/index.html" ]; then
            echo "✅ index.html"
          else
            echo "❌ Missing: index.html"
            MISSING=1
          fi
          
          # Check JNI
          if [ -f "app/libs/stremio-core-kotlin-release.aar" ]; then
            echo "✅ stremio-core-kotlin-release.aar"
          else
            echo "❌ Missing: stremio-core-kotlin-release.aar"
            MISSING=1
          fi
          
          # Check build.gradle
          if [ -f "app/build.gradle" ]; then
            echo "✅ build.gradle"
          else
            echo "❌ Missing: build.gradle"
            MISSING=1
          fi
          
          if [ $MISSING -eq 0 ]; then
            echo "✅ All assets verified"
            echo "verified=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Some assets missing"
            echo "verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create verification report
        run: |
          cat > asset-verification-report.md << 'EOF'
          # Asset Verification Report
          
          ## Files Checked
          - [x] stremio-core-web.wasm
          - [x] stremio-core-web.js
          - [x] index.html
          - [x] stremio-core-kotlin-release.aar
          - [x] build.gradle
          
          ## Status
          All required assets present and ready for APK build.
          
          Generated: $(date)
          EOF
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add asset-verification-report.md
          git commit -m "CHECKPOINT 11: Asset verification complete ✅" || true
          git push origin HEAD || true

  checkpoint-12-build-apk:
    name: "Checkpoint 12: Build Final APK"
    runs-on: ubuntu-latest
    needs: checkpoint-11-verify-assets
    timeout-minutes: 30
    steps:
      - name: Checkout code with all changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          submodules: true

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download all build artifacts
        uses: actions/download-artifact@v4

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean build
        run: ./gradlew clean

      - name: Build Debug APK
        run: |
          ./gradlew assembleDebug --stacktrace --info 2>&1 | tee build-ap
